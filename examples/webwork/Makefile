## ********************************************************************* ##
## Copyright 2015-7                                                      ##
## Robert A. Beezer, Michael Gage, Geoff Goehle, Alex Jordan             ##
##                                                                       ##
## This file is part of PreTeXt.                                         ##
##                                                                       ##
## PreTeXt is free software: you can redistribute it and/or modify       ##
## it under the terms of the GNU General Public License as published by  ##
## the Free Software Foundation, either version 2 or version 3 of the    ##
## License (at your option).                                             ##
##                                                                       ##
## PreTeXt is distributed in the hope that it will be useful,            ##
## but WITHOUT ANY WARRANTY; without even the implied warranty of        ##
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the         ##
## GNU General Public License for more details.                          ##
##                                                                       ##
## You should have received a copy of the GNU General Public License     ##
## along with PreTeXt. If not, see <http://www.gnu.org/licenses/>.       ##
## ********************************************************************* ##

#######################
# DO NOT EDIT THIS FILE
#######################

#   1) Do make a copy of Makefile.paths.original
#      as Makefile.paths
#   2) Edit Makefile.paths as directed there
#   3) This file (Makefile) and Makefile.paths.original
#      are managed by revision control and edits will conflict
#   4) See updated history in Makefile.paths.original
#      for changes, or follow the revision control history

##############
# Introduction
##############

# This is not a "true" makefile, since it does not
# operate on dependencies.  It is more of a shell
# script, sharing common configurations

######################
# System Prerequisites
######################

#   install         (system tool to make directories)
#   xsltproc        (xml/xsl text processor)
#   xmllint         (only to check source against DTD)
#   <helpers>       (PDF viewer, web browser, pager, Sage executable, etc)

#####
# Use
#####

#	A) Set default directory to be the location of this file
#	B) At command line:  make <some-target>

# The included file contains customized versions
# of locations of the principal components of this
# project and names of various helper executables
include Makefile.paths

# These paths are subdirectories of
# the Mathbook XML distribution
# MBUSR is where extension files get copied
# so relative paths work properly
MBXSL = $(MB)/xsl
MBUSR = $(MB)/user
WWEXAMPLE = $(MB)/examples/webwork
DTD = $(MB)/schema/dtd

# XML to apply templates to
SMPCHP = $(WWEXAMPLE)/sample-chapter/sample-chapter.xml
MINI = $(WWEXAMPLE)/minimal/mini.xml

# These paths are subdirectories of
# the scratch directory
PGOUT      = $(SCRATCH)/pg
HTMLOUT    = $(SCRATCH)/html
PDFOUT     = $(SCRATCH)/pdf
EPUBOUT    = $(SCRATCH)/epub
WWOUT      = $(SCRATCH)/webwork-representations

# Some aspects of producing these examples require a WeBWorK server.
# Either specify only the protocol and domain (like https://webwork.yourschool.edu)
# or specify a 5-tuple with quotes exactly as in this example
# SERVER = "(https://webwork-ptx.aimath.org,courseID,userID,password,course_password)"
# NOTE: it is IMPORTANT to get the protocol correct for your server (HTTP versus HTTPS)
SERVER = https://webwork-ptx.aimath.org


################
#Targets for make
################

# TODO: generate "latex images" for the sample chapter, using the pretext
# script AND using the publisher file, to be certain the one such image
# has the right automatic xml:id  (2020-07-28)

#  Extract webwork problems into a single XML file called
#  webwork-representations.xml which holds multiple versions of each problem.
#  Also locally store images from the WeBWorK server.

#  For HTML and problem set output, we turn off dates in file headers,
#  so when we use these for testing we can get more accurate diffs.
#  Dates are useful for single file output (or at least less of an
#  annoyance).  This should not be taken as necessary or best practice
#  for a real PreTeXt project using WeBWorK problems.
#  This looks like "-stringparam debug.datedfiles no".

sample-chapter-representations:
	install -d $(WWOUT)
	-rm $(WWOUT)/webwork-representations.ptx
	$(MB)/pretext/pretext -v -c webwork -d $(WWOUT) -s $(SERVER) $(SMPCHP)

mini-representations:
	install -d $(WWOUT)
	-rm $(WWOUT)/webwork-representations.ptx
	$(MB)/pretext/pretext -v -c webwork -d $(WWOUT) -s $(SERVER) $(MINI)

# LaTeX and PDF versions
# See prerequisite above about merge files.
# xsltproc may be passed --stringparam latex.fillin.style box for box answer blanks

sample-chapter-pdf:
	install -d $(PDFOUT)
	install -d $(PDFOUT)/images
	-rm $(PDFOUT)/*.*
	-rm $(PDFOUT)/images/*
	cp -a $(WWOUT)/*.png $(PDFOUT)/images
	cp -a $(WWOUT)/*.pdf $(PDFOUT)/images
	cp $(WWOUT)/webwork-representations.ptx $(WWEXAMPLE)/sample-chapter
	cd $(PDFOUT); \
	xsltproc -stringparam publisher publication.xml -o sample-ww-chapter.tex $(MBXSL)/pretext-latex.xsl  $(SMPCHP); \
	xelatex sample-ww-chapter.tex; \
	xelatex sample-ww-chapter.tex; \

mini-pdf:
	install -d $(PDFOUT)
	install -d $(PDFOUT)/images
	-rm $(PDFOUT)/*.*
	-rm $(PDFOUT)/images/*
	-cp -a $(WWOUT)/*.png $(PDFOUT)/images
	cp $(WWOUT)/webwork-representations.ptx $(WWEXAMPLE)/minimal
	cd $(PDFOUT); \
	xsltproc -stringparam publisher publication.xml -o webwork-mini.tex $(MBXSL)/pretext-latex.xsl $(MINI); \
	xelatex webwork-mini.tex; \
	xelatex webwork-mini.tex; \

# HTML output
# See prerequisite above about merge files.
sample-chapter-html:
	install -d $(HTMLOUT)
	-rm $(HTMLOUT)/*.html
	-rm $(HTMLOUT)/knowl/*.html
	cp -a $(WWEXAMPLE)/sample-chapter/images $(HTMLOUT)
	cp -a $(WWOUT)/*.svg $(HTMLOUT)/images
	cp -a $(WWOUT)/*.png $(HTMLOUT)/images
	cp $(WWOUT)/webwork-representations.ptx $(WWEXAMPLE)/sample-chapter
	cd $(HTMLOUT); \
	xsltproc -stringparam publisher publication.xml -stringparam webwork.divisional.static no -stringparam debug.datedfiles no $(MBXSL)/pretext-html.xsl $(SMPCHP);

mini-html:
	install -d $(HTMLOUT)
	-rm $(HTMLOUT)/*.html
	-rm $(HTMLOUT)/knowl/*.html
	cp $(WWOUT)/webwork-representations.ptx $(WWEXAMPLE)/minimal
	cd $(HTMLOUT); \
	xsltproc -stringparam publisher publication.xml -stringparam debug.datedfiles no $(MBXSL)/pretext-html.xsl $(MINI);

#  Make an archive of webwork problem sets for each "section" (as specified
#  by chunk level) with set definition files, set header files, and problem
#  files in a file tree. Separate problem sets for inline and divisional
#  problems. Requires the merged PTX file from above.

sample-chapter-problem-sets:
	install -d $(PGOUT)
	cp $(WWOUT)/webwork-representations.ptx $(WWEXAMPLE)/sample-chapter
	cd $(PGOUT); \
	rm -r Integrating_WeBWorK_into_Textbooks; \
	xsltproc -stringparam publisher publication.xml -stringparam chunk.level 1 -stringparam debug.datedfiles no $(MBXSL)/pretext-ww-problem-sets.xsl $(SMPCHP)

mini-problem-sets:
	install -d $(PGOUT)
	cp $(WWOUT)/webwork-representations.ptx $(WWEXAMPLE)/minimal
	cd $(PGOUT); \
	rm -r WeBWorK_Minimal_Example; \
	xsltproc -stringparam publisher publication.xml -stringparam chunk.level 1 -stringparam debug.datedfiles no $(MBXSL)/pretext-ww-problem-sets.xsl $(MINI)

###########
# Utilities
###########

# Verify Source integrity
#   Leaves "jingreport.txt" in SCRATCH
#   Automatically invokes the "less" pager, could configure as $(PAGER)
sample-chapter-check:
	install -d $(SCRATCH)
	-rm $(SCRATCH)/jingreport.txt
	-java -classpath $(JINGTRANG) -Dorg.apache.xerces.xni.parser.XMLParserConfiguration=org.apache.xerces.parsers.XIncludeParserConfiguration -jar $(JINGTRANG)/jing.jar $(MB)/schema/pretext.rng $(SMPCHP) > $(SCRATCH)/jingreport.txt
	less $(SCRATCH)/jingreport.txt

webwork-mini-check:
	install -d $(SCRATCH)
	-rm $(SCRATCH)/jingreport.txt
	-java -classpath $(JINGTRANG) -Dorg.apache.xerces.xni.parser.XMLParserConfiguration=org.apache.xerces.parsers.XIncludeParserConfiguration -jar $(JINGTRANG)/jing.jar $(MB)/schema/pretext.rng $(MINI) > $(SCRATCH)/jingreport.txt
	less $(SCRATCH)/jingreport.txt
