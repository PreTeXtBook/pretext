<?xml version="1.0" encoding="UTF-8"?>

<!--   This file is part of the documentation of PreTeXt      -->
<!--                                                          -->
<!--      PreTeXt Publisher's Guide                           -->
<!--                                                          -->
<!-- Copyright (C) 2013-2021  Robert A. Beezer, David Farmer  -->
<!-- See the file COPYING for copying conditions.             -->

<chapter xml:id="epub">
    <title>Conversion to EPUB/Kindle</title>
    <idx><h>epub</h></idx>
    <idx><h>kindle</h></idx>
    <introduction>
        <p><init>EPUB</init> is the standard format for electronic books. Books in <init>EPUB</init> format can be read using applications on a variety of platforms. (Apple Books across the entire Apple ecosystem. <url href="http://calibre-ebook.com" visible="calibre-ebook.com">Calibre</url> is open source and cross-platform for desktop usage. Android devices have options as well.) Amazon's Kindle devices use a proprietary format that is derived from <init>EPUB</init>. Through much experimentation, the <pretext /> team has determined that <init>SVG</init> mathematics, generated by MathJax offline tools, works well in all ebook readers <em>other</em> than Kindle apps and devices. For Kindle, MathML is the best format. (Apple's MathML implementation is very poor as of July 2021, and so we cannot recommend math formatted using MathML for situations where readers may use the Apple Books app.) Thus, we provide <em>two</em> pathways for production of electronic books. These formats are useful as an offline version, which is superior to a <init>PDF</init> in some ways, such as font face and font size being controlled by the software in an e-reader device.  However, it is inferior to the online version (<xref ref="online-html"/>), since many interactive features cannot function within the <init>EPUB</init> version.</p>
    </introduction>

    <section>
        <title>Prerequisites</title>
        <p>
            There are a handful of prerequisites to build an <init>EPUB</init> version of a book.
            <ul>
                <li>
                    <p>
                        You must use either the <pretext />-CLI or the <c>pretext/pretext</c> script, since creating an <init>EPUB</init> file is a multi-stage process; building with <c>xsltproc</c> is not supported.
                    </p>
                </li>
                <li>
                    <p>
                        You must have <c>node</c> and <c>npm</c> must be installed.  See <xref ref="node-and-npm"/> for more on <c>node</c> and <c>npm</c>.
                    </p>
                </li>
                <li>
                    <p>
                        You must use a publication file (referred to below as <c>publication.ptx</c>) with <cd>source/directories/@generated</cd> and <cd>source/directories/@external</cd> so that images can be located and bundled (these are included by default if you use <c>pretext new</c> or <c>pretext init</c> for your project).
                    </p>

                    <p>
                        To use a non-generic cover image, the publication file must also have <c>epub/cover/@front</c> attribute that points to the cover image (<init>JPEG</init> or <init>PNG</init>, 2048 pixels tall, 1280 pixels wide).  Absent an image provided, there will be an attempt to create a simple, generic cover image.  See <xref ref="epub-cover-image-option"/> for details about specifying a cover image.
                    </p>
                </li>
            </ul>
            If you use the <c>pretext/pretext</c> script, you will need to generate any source-defined images in <init>SVG</init> format for standard <init>EPUB</init>, and <init>PNG</init> format for Kindle.
        </p>

        <p>
            Finally, if you are using the <c>pretext/pretext</c> script, you must install a local version of MathJax (the CLI will try to do this for you).  We provide a bash script in <c>scripts/mjsre</c> that automates this process.  See <xref ref="install-mathjax"/> for instructions.  As updates to the <init>EPUB</init> conversion are released, you may occasionally want to update your local copy of MathJax.  Simply use the script referenced above.
        </p>

        <p>
            To use the CLI, you will need to create a new target in the project manifest (project.ptx).  The target should look something like the following.
        </p>

        <pre>
        <![CDATA[
            <target name="ebook">
                <format>epub</format>
                <source>source/main.ptx</source>
                <publication>publication/publication.ptx</publication>
                <output-dir>output/epub</output-dir>
            </target>
        ]]>
        </pre>
        <p>
            The <attr>name</attr> can be whatever you wish, but the <tag>format</tag> must be epub or kindle.  You won't be able to tell the output files apart, so if you want both an epub and a kindle, name the output directory differently for each.
        </p>

    </section>

    <section>
        <title>Converting and validating</title>
        <p>
            First we will describe how to convert to epub or kindle using the CLI.  Assuming you have added a target with name <q>ebook</q> and format <q>epub</q>, simply run:
        </p>
        <console>
            <input>pretext build ebook -g</input>
        </console>

        <p>
            If instead, you wish to use the <c>pretext/pretext</c> script, make sure to first generate images into the correct format (<init>SVG</init> for regular <init>EPUB</init> and <init>PNG</init> for kindle).
            Converting to <init>EPUB</init> with <init>SVG</init> math (used everywhere other than Kindle), run as a single command-line
            <cd>
                <cline>/path/to/mathbook/pretext/pretext -c all -f epub-svg</cline>
                <cline>    -p publication.xml -d /path/to/output</cline>
                <cline>    /path/to/yourmainfile.ptx</cline>
            </cd>
            For an <init>EPUB</init> file destined for Kindle, use the single command-line
            <cd>
                <cline>/path/to/mathbook/pretext/pretext -c all -f epub-kindle</cline>
                <cline>    -p publication.xml -d /path/to/output</cline>
                <cline>    /path/to/yourmainfile.ptx</cline>
            </cd>
        </p>

        <p>
            If you would like to name your output file something other than the name inferred from the root xml:id, you can use <c>-o path/to/output/filename.epub</c> instead of the <c>-d</c> option.
        </p>

        <p>For the standard <init>EPUB</init> conversion, any standard <init>EPUB</init> reader should work. MacOS users will find the Apple Book app is likely their default. Calibre is useful for an alternative view and works on Windows and Linux as well. For the Kindle conversion, you will need to get <url href="https://www.amazon.com/gp/feature.html?ie=UTF8&amp;docId=1000765261" visual="www.amazon.com/gp/feature.html?ie=UTF8&amp;docId=1000765261">Amazon's Kindle Previewer app</url> (macOS and Windows only). For reasons we do not understand, some books crash the Kindle Previewer app, in which case you should try loading the <init>EPUB</init> file into the Amazon KDP web interface, which also offers a preview. (This preview is the only option for Linux users.)</p>

        <p>Many <init>EPUB</init> marketplaces are strict about requiring that your <init>EPUB</init> file pass validation by the open source <c>epubcheck</c> validation tool. You may be able to install a command-line version of <c>epubcheck</c> using your operating system's package management tool. A free Java-based GUI version <url href="https://www.pagina.gmbh/produkte/epub-checker/" visual="www.pagina.gmbh/produkte/epub-checker/">released by Pagina</url> might be useful. There is also a (slow, limited) online version.  More pointers can be found at the <url href="https://www.w3.org/publishing/epubcheck/" visual="www.w3.org/publishing/epubcheck/">W3 EPUBCheck</url> site.  Please report validation errors and oddly-formatted electronic book output to the <c>pretext-support</c> Google group. Some aspects of <pretext /> have not yet been fully implemented for <init>EPUB</init>, but we will endeavor to support them as demand arises.</p>
    </section>

    <section>
        <title>Distribution</title>
        <p>Because the <init>EPUB</init> file built for Kindle is different than what we build for all other readers, you <em>must</em> distribute the Kindle version of your book through Amazon's KDP. Because Amazon and Kindle have the overwhelming majority of the electronic book market in the United States, if your readers are mainly in the United States, we highly recommend that you get your Kindle version in good shape.</p>
        <p>Distribution of the <init>EPUB</init> file produced by the <c>epub-svg</c> conversion can be done through electronic book aggregators. There are many options available, and they all take an additional commission on top of what the electronic book marketplace through which a reader buys your book takes, but using such a service can save you from needing to post your electronic book on a variety of marketplaces. <alert>Do not allow an aggregator to distribute your book to Amazon, as the math will not render properly.</alert> It is as simple as <em>not</em> checking the box for Amazon when signing up with an aggregator to opt out of having the aggregator send your book to Amazon.</p>
    </section>
</chapter>
